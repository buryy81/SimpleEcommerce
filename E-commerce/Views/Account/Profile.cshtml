@model SimpleEcommerce.Models.User
@using SimpleEcommerce.Models

@{
    ViewData["Title"] = "Личный кабинет";
    var transactions = ViewBag.Transactions as List<Transaction> ?? new List<Transaction>();
    var activeWithdrawal = ViewBag.ActiveWithdrawal as PendingRequest;
    var activeTopUp = ViewBag.ActiveTopUp as PendingRequest;
}

<div class="container mt-4">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center"
                             style="width: 80px; height: 80px;">
                            <span class="text-white fs-2 fw-bold">@Model.FirstName[0]</span>
                        </div>
                    </div>

                    <h4 class="mb-1">@Model.FullName</h4>
                    <p class="text-muted mb-3">@Model.Email</p>

                    <div class="border-top pt-3 mt-3">
                        <div class="text-center">
                            <div class="text-muted small mb-1">Баланс счета</div>
                            <div class="fw-bold text-dark" style="font-size: 1.5rem; letter-spacing: 0.5px;">
                                @Model.Balance.ToString("N0") <span class="text-muted" style="font-size: 1rem;">₽</span>
                                @if (activeWithdrawal != null)
                                {
                                    <span class="text-warning" style="font-size: 0.9rem;">(на вывод @activeWithdrawal.Amount.ToString("N0") ₽)</span>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 d-grid gap-2">
                        <button class="btn btn-success w-100" type="button" 
                                data-bs-toggle="modal"
                                data-bs-target="#topUpModal">
                            <i class="bi bi-arrow-up-circle me-2"></i>Пополнить баланс
                        </button>
                        <button class="btn btn-outline-primary w-100" type="button" 
                                id="withdrawalBtn" 
                                @(Model.WithdrawalEnabled ? "" : "disabled")
                                data-bs-toggle="@(Model.WithdrawalEnabled ? "modal" : "")"
                                data-bs-target="@(Model.WithdrawalEnabled ? "#withdrawalModal" : "")">
                            <i class="bi bi-arrow-down-circle me-2"></i>Вывод средств
                        </button>
                        @if (!Model.WithdrawalEnabled)
                        {
                            <small class="text-muted text-center">Вывод средств временно недоступен</small>
                        }
                        <a href="@Url.Action("Logout")" class="btn btn-outline-danger w-100">
                            <i class="bi bi-box-arrow-right me-2"></i>Выйти
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 fw-semibold">
                        <i class="bi bi-clock-history me-2"></i>История операций
                    </h5>
                </div>
                <div class="card-body p-0">
                    @if (transactions.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var transaction in transactions)
                            {
                                var isPositive = transaction.Amount > 0;
                                var isWithdrawal = transaction.Type == "Вывод средств";
                                var isTopUp = transaction.Type == "Пополнение";
                                
                                // Проверяем статус транзакций
                                var isWithdrawalPending = isWithdrawal && transaction.Description?.Contains("Заявка на вывод средств") == true;
                                var isWithdrawalConfirmed = isWithdrawal && !isWithdrawalPending && transaction.Description?.Contains("Вывод средств") == true;
                                var isTopUpPending = isTopUp && transaction.Description?.Contains("Заявка на пополнение баланса") == true;
                                var isTopUpConfirmed = isTopUp && !isTopUpPending && (transaction.Description?.Contains("Пополнение счета") == true || transaction.Description?.Contains("подтверждена") == true || transaction.Description?.Contains("подтвержден") == true);
                                
                                // Определяем иконку и стили
                                string iconClass;
                                string iconBg;
                                string badgeClass;
                                
                                if (isWithdrawalConfirmed || isTopUpConfirmed)
                                {
                                    // Заявка подтверждена - зеленая галочка
                                    iconClass = "bi-check-circle text-success";
                                    iconBg = "bg-success bg-opacity-10";
                                    badgeClass = "bg-success";
                                }
                                else if (isWithdrawalPending && activeWithdrawal != null && Math.Abs(transaction.Amount) == activeWithdrawal.Amount)
                                {
                                    // Активная заявка на вывод - иконка таймера
                                    iconClass = "bi-hourglass-split text-warning";
                                    iconBg = "bg-warning bg-opacity-10";
                                    badgeClass = "bg-warning";
                                }
                                else if (isTopUpPending && activeTopUp != null && transaction.Amount == activeTopUp.Amount)
                                {
                                    // Активная заявка на пополнение - иконка таймера
                                    iconClass = "bi-hourglass-split text-warning";
                                    iconBg = "bg-warning bg-opacity-10";
                                    badgeClass = "bg-warning";
                                }
                                else if (isPositive)
                                {
                                    iconClass = "bi-arrow-down-circle text-success";
                                    iconBg = "bg-success bg-opacity-10";
                                    badgeClass = "bg-success";
                                }
                                else
                                {
                                    iconClass = "bi-arrow-up-circle text-danger";
                                    iconBg = "bg-danger bg-opacity-10";
                                    badgeClass = "bg-danger";
                                }
                                
                                var amountDisplay = isPositive ? $"+{transaction.Amount:N0}" : $"{transaction.Amount:N0}";
                                
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="@iconBg rounded-circle p-2 me-3">
                                            <i class="bi @iconClass"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">@transaction.Description</h6>
                                            <small class="text-muted">@transaction.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy, HH:mm")</small>
                                        </div>
                                    </div>
                                    <span class="badge @badgeClass fs-6">@amountDisplay ₽</span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 48px;"></i>
                            <p class="text-muted mt-3 mb-0">История операций пуста</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно пополнения баланса -->
<div class="modal fade" id="topUpModal" tabindex="-1" aria-labelledby="topUpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="topUpModalLabel">Пополнение баланса</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addFundsForm" method="post" action="@Url.Action("AddFunds", "Account")">
                    @Html.AntiForgeryToken()
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Сумма пополнения (₽):</label>
                        <input type="number" class="form-control form-control-lg" name="amount" id="topUpAmountInput" min="100" step="100" value="1000" required>
                        <small class="text-muted">Минимальная сумма: 100 ₽</small>
                    </div>
                
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-credit-card me-2"></i>Реквизиты для перевода</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label text-muted small">Номер карты</label>
                                <div class="input-group">
                                    <input type="text" class="form-control fw-bold" value="5536 9138 1234 5678" id="topUpCardNumber" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="copyTopUpCardBtn">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label text-muted small">Получатель</label>
                                <p class="mb-0 fw-semibold">ИП Иванов Иван Иванович</p>
                            </div>
                            <div>
                                <label class="form-label text-muted small">Назначение платежа</label>
                                <p class="mb-0 text-muted small">Пополнение баланса</p>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mb-4">
                        <p class="mb-2 fw-semibold">Или отсканируйте QR-код</p>
                        <div class="bg-light p-3 rounded d-inline-block">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=1000" alt="QR Code" class="img-fluid" style="max-width: 200px;" id="topUpQrCode">
                        </div>
                    </div>

                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        После перевода нажмите кнопку "Перевел" для подтверждения платежа
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="confirmTopUpBtn">
                    <i class="bi bi-check-circle me-2"></i>Перевел
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно вывода средств -->
@if (Model.WithdrawalEnabled)
{
    <div class="modal fade" id="withdrawalModal" tabindex="-1" aria-labelledby="withdrawalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="withdrawalModalLabel">Вывод средств</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="withdrawalForm" method="post" action="#" onsubmit="return false;">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="withdrawalAmount" class="form-label fw-semibold">Сумма вывода (₽)</label>
                            <input type="number" class="form-control form-control-lg" 
                                   id="withdrawalAmount" name="amount" 
                                   step="0.01" min="1" max="@Model.Balance.ToString(System.Globalization.CultureInfo.InvariantCulture)" 
                                   value="" required>
                            <small class="text-muted">Доступно для вывода: <strong>@Model.Balance.ToString("N0") ₽</strong></small>
                        </div>

                        <div class="mb-3">
                            <label for="bankSelect" class="form-label fw-semibold">Банк</label>
                            <select class="form-select form-select-lg" id="bankSelect" name="bank" required>
                                <option value="">Выберите банк</option>
                                <option value="Сбербанк">Сбербанк</option>
                                <option value="ВТБ">ВТБ</option>
                                <option value="Альфа-Банк">Альфа-Банк</option>
                                <option value="Тинькофф">Тинькофф</option>
                                <option value="Райффайзенбанк">Райффайзенбанк</option>
                                <option value="Газпромбанк">Газпромбанк</option>
                                <option value="Другой">Другой</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="cardOrPhone" class="form-label fw-semibold">Номер карты или телефона</label>
                            <input type="text" class="form-control form-control-lg" 
                                   id="cardOrPhone" name="cardOrPhone" 
                                   placeholder="0000 0000 0000 0000 или +7 (999) 999-99-99" required>
                            <small class="text-muted">Введите номер карты или номер телефона для получения средств</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-primary" id="submitWithdrawalBtn">
                            <i class="bi bi-check-circle me-2"></i>Вывести средства
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('withdrawalForm');
            const submitBtn = document.getElementById('submitWithdrawalBtn');
            const withdrawalModal = document.getElementById('withdrawalModal');
            const withdrawalAmountInput = document.getElementById('withdrawalAmount');
            
            if (!form || !submitBtn) {
                console.log('Форма или кнопка не найдены. Форма:', form, 'Кнопка:', submitBtn);
                return;
            }
            
            console.log('Инициализация формы вывода средств');
            
            // При открытии модального окна заполняем поле максимальной суммой
            if (withdrawalModal && withdrawalAmountInput) {
                const maxAmount = parseFloat('@Model.Balance.ToString(System.Globalization.CultureInfo.InvariantCulture)') || 0;
                withdrawalModal.addEventListener('show.bs.modal', function() {
                    if (maxAmount > 0) {
                        // Используем точку как разделитель десятичных знаков
                        const formattedValue = maxAmount.toFixed(2);
                        withdrawalAmountInput.value = formattedValue;
                        withdrawalAmountInput.max = maxAmount;
                        // Принудительно устанавливаем значение с точкой
                        setTimeout(function() {
                            withdrawalAmountInput.value = formattedValue;
                        }, 100);
                    } else {
                        withdrawalAmountInput.value = '';
                    }
                });
                
                // Нормализуем значение при вводе (заменяем запятую на точку)
                withdrawalAmountInput.addEventListener('input', function(e) {
                    let value = e.target.value;
                    // Заменяем запятую на точку
                    if (value.includes(',')) {
                        value = value.replace(',', '.');
                        e.target.value = value;
                    }
                });
                
                // Нормализуем значение при потере фокуса
                withdrawalAmountInput.addEventListener('blur', function(e) {
                    let value = e.target.value;
                    if (value.includes(',')) {
                        value = value.replace(',', '.');
                        e.target.value = value;
                    }
                });
            }
            
            function handleWithdrawalSubmit() {
                console.log('Начало обработки вывода средств');
                const form = document.getElementById('withdrawalForm');
                const submitBtn = document.getElementById('submitWithdrawalBtn');
                
                if (!form || !submitBtn) {
                    console.error('Форма или кнопка не найдены в handleWithdrawalSubmit');
                    return;
                }
                
                // Получаем значение суммы, нормализуя его (заменяя запятую на точку)
                let amountValue = document.getElementById('withdrawalAmount').value;
                // Убираем все пробелы и заменяем запятую на точку
                amountValue = amountValue.replace(/\s/g, '').replace(',', '.');
                // Обновляем значение в поле, если оно было изменено
                if (amountValue !== document.getElementById('withdrawalAmount').value) {
                    document.getElementById('withdrawalAmount').value = amountValue;
                }
                const amount = parseFloat(amountValue);
                const bank = document.getElementById('bankSelect').value;
                const cardOrPhone = document.getElementById('cardOrPhone').value;
                const maxAmount = parseFloat('@Model.Balance.ToString(System.Globalization.CultureInfo.InvariantCulture)') || 0;
                
                console.log('Парсинг суммы. Исходное значение:', document.getElementById('withdrawalAmount').value, 'Нормализованное:', amountValue, 'Результат parseFloat:', amount);
                
                if (isNaN(amount) || amount <= 0) {
                    alert('Введите корректную сумму');
                    return;
                }
                
                if (amount > maxAmount) {
                    alert('Недостаточно средств на балансе');
                    return;
                }
                
                if (!bank) {
                    alert('Выберите банк');
                    return;
                }
                
                if (!cardOrPhone.trim()) {
                    alert('Введите номер карты или телефона');
                    return;
                }
                
                // Отключаем кнопку
                submitBtn.disabled = true;
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Обработка...';
                
                const formData = new FormData(form);
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                
                // Формируем URL для запроса
                const url = '@Url.Action("RequestWithdrawal", "Account")';
                console.log('Отправка запроса на:', url);
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: new URLSearchParams(formData)
                })
                .then(response => {
                    // Проверяем, что ответ является JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('Сервер вернул не JSON ответ');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Закрываем модальное окно
                        const withdrawalModal = document.getElementById('withdrawalModal');
                        if (withdrawalModal && typeof bootstrap !== 'undefined') {
                            const modalInstance = bootstrap.Modal.getInstance(withdrawalModal);
                            if (modalInstance) {
                                modalInstance.hide();
                            }
                        }
                        
                        // Показываем сообщение об успехе
                        alert(data.message || 'Заявка на вывод средств успешно создана');
                        
                        // Перезагружаем страницу
                        window.location.reload();
                    } else {
                        alert(data.message || 'Произошла ошибка при создании заявки на вывод');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Произошла ошибка при создании заявки на вывод. Пожалуйста, попробуйте еще раз.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
            }
            
            // Обработчик на кнопке
            submitBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Клик по кнопке вывода средств');
                handleWithdrawalSubmit();
            });
            
            // Обработчик на форме (на случай если форма отправляется другим способом)
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Отправка формы вывода средств');
                handleWithdrawalSubmit();
                return false;
            });
        });
        
        // Обработка пополнения баланса
        document.addEventListener('DOMContentLoaded', function() {
            const topUpModal = document.getElementById('topUpModal');
            const topUpAmountInput = document.getElementById('topUpAmountInput');
            const topUpQrCode = document.getElementById('topUpQrCode');
            const copyTopUpCardBtn = document.getElementById('copyTopUpCardBtn');
            const confirmTopUpBtn = document.getElementById('confirmTopUpBtn');
            const addFundsForm = document.getElementById('addFundsForm');
            
            // Обновление QR-кода при изменении суммы
            if (topUpModal && topUpAmountInput && topUpQrCode) {
                topUpModal.addEventListener('show.bs.modal', function() {
                    topUpAmountInput.value = '1000';
                    updateTopUpQR();
                });
                
                topUpAmountInput.addEventListener('input', function() {
                    updateTopUpQR();
                });
                
                function updateTopUpQR() {
                    const amount = topUpAmountInput.value || '1000';
                    topUpQrCode.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${amount}`;
                }
            }
            
            // Копирование номера карты
            if (copyTopUpCardBtn) {
                copyTopUpCardBtn.addEventListener('click', function() {
                    const cardInput = document.getElementById('topUpCardNumber');
                    if (cardInput) {
                        cardInput.select();
                        document.execCommand('copy');
                        const originalText = this.innerHTML;
                        this.innerHTML = '<i class="bi bi-check"></i>';
                        setTimeout(() => {
                            this.innerHTML = originalText;
                        }, 2000);
                    }
                });
            }
            
            // Подтверждение пополнения
            if (confirmTopUpBtn && addFundsForm) {
                confirmTopUpBtn.addEventListener('click', function() {
                    const amount = parseFloat(topUpAmountInput.value);
                    
                    if (!amount || amount < 100) {
                        alert('Минимальная сумма пополнения: 100 ₽');
                        return;
                    }
                    
                    if (!confirm(`Подтвердите пополнение баланса на сумму ${amount.toLocaleString('ru-RU')} ₽?`)) {
                        return;
                    }
                    
                    const originalText = this.innerHTML;
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Обработка...';
                    
                    const formData = new FormData(addFundsForm);
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                    
                    fetch(addFundsForm.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': token
                        },
                        body: new URLSearchParams(formData)
                    })
                    .then(response => {
                        if (response.ok) {
                            // Закрываем модальное окно
                            const modal = bootstrap.Modal.getInstance(topUpModal);
                            if (modal) {
                                modal.hide();
                            }
                            // Обновляем страницу
                            location.reload();
                        } else {
                            throw new Error('Ошибка при пополнении баланса');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                        alert('Произошла ошибка при пополнении баланса. Попробуйте еще раз.');
                        this.disabled = false;
                        this.innerHTML = originalText;
                    });
                });
            }
        });
    </script>
}